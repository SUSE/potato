#!/usr/bin/env ruby

require_relative '../config/boot'
$LOAD_PATH.unshift File.expand_path(File.join(__dir__, '../lib/'))

require 'rmt'
require 'rmt/mirror'
require 'rmt/config'
require 'rmt/repo_manager'

require 'active_record'
require 'terminal-table'
require "thor"

require_relative '../app/models/application_record.rb'

Dir[File.join(__dir__, '..', 'app', 'models', '**', '*.rb')].each { |file| require File.expand_path(file) }

db_config_path = File.join(__dir__, '../config/database.yml')
db_config = YAML.safe_load(ERB.new(File.read(db_config_path)).result, [], [], true)

ActiveRecord::Base.establish_connection(db_config['development'])


class MyCLI < Thor
  desc "list", "List all repositories"
  option :all, type: :boolean
  def list
    scope = options[:all] ? :all : :enabled
    RMT::RepoManager.new(ARGV, STDOUT).list_repositories(scope: scope)
  end

  desc "version", "Show version"
  def version
    puts RMT::VERSION
  end
end

MyCLI.start(ARGV)
