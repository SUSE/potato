#!/usr/bin/env ruby

require_relative '../config/boot'
require 'pathname'
require 'config'

require_relative '../lib/rmt'
require_relative '../lib/rmt/mirror'
require_relative '../lib/rmt/rpm'
require_relative '../lib/rmt/downloader'

repository_url = ARGV[0]
local_path = ARGV[1]

unless (repository_url and local_path)
  STDERR.puts 'Usage: rmt-mirror [repository_url] [local_path]'
  exit 1
end

Config.load_and_set_settings(
  File.join(File.dirname(__FILE__), '../config/rmt.yml'),
  File.join(File.dirname(__FILE__), '../config/rmt.local.yml')
)

begin
  RMT::Mirror.new(
    mirroring_base_dir: Settings.mirroring.base_dir,
    repository_url: repository_url,
    local_path: local_path,
    mirror_src: Settings.mirroring.mirror_src,
    logger: Logger.new(STDOUT)
  ).mirror
rescue RMT::Mirror::Exception => e
  warn e.to_s
  exit 1
end
